name: Build and Publish to npm

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org/'
      - run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      - run: npm install
      - name: Bump version and publish
        run: |
          # Get the latest tag version
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v1.0.0")
          CURRENT_VERSION=${LATEST_TAG#v}
          
          # Calculate next patch version
          IFS='.' read -r -a VERSION_PARTS <<< "$CURRENT_VERSION"
          MAJOR="${VERSION_PARTS[0]}"
          MINOR="${VERSION_PARTS[1]}"
          PATCH="${VERSION_PARTS[2]}"
          NEXT_PATCH=$((PATCH + 1))
          NEW_VERSION="$MAJOR.$MINOR.$NEXT_PATCH"
          
          echo "Bumping from tag $LATEST_TAG ($CURRENT_VERSION) to $NEW_VERSION"
          
          # Update package.json with new version (for npm publish only, not committed)
          npm version $NEW_VERSION --no-git-tag-version
          
          # Delete tag if it exists
          git tag -d "v$NEW_VERSION" 2>/dev/null || echo "Tag doesn't exist locally"
          git push origin --delete "v$NEW_VERSION" 2>/dev/null || echo "Tag doesn't exist on remote"
          
          # Create and push tag (without committing package.json)
          git tag -a "v$NEW_VERSION" -m "Version $NEW_VERSION"
          git push origin "v$NEW_VERSION"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      - run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
